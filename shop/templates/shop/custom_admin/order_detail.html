{% extends 'shop/custom_admin/base.html' %}

{% block title %}Sipariş #{{ order.order_number }} - Admin Panel{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Sipariş #{{ order.order_number }}</h1>
            <p class="text-gray-600 mt-1">{{ order.created_at|date:"d.m.Y H:i" }}</p>
        </div>
        <div class="flex items-center space-x-3">
            <a href="{% url 'shop:admin_orders' %}" class="text-gray-600 hover:text-gray-800">
                <i class="fas fa-arrow-left mr-2"></i>Geri Dön
            </a>
            <button class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-print mr-2"></i>Yazdır
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Order Items -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-box text-purple-600 mr-2"></i>
                    Sipariş Ürünleri
                </h2>
                
                <div class="space-y-4">
                    {% for item in order.items.all %}
                    <div class="flex items-center space-x-4 p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                        {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-20 h-20 object-cover rounded-lg">
                        {% else %}
                        <div class="w-20 h-20 bg-gray-200 rounded-lg flex items-center justify-center">
                            <i class="fas fa-image text-gray-400 text-2xl"></i>
                        </div>
                        {% endif %}
                        
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">{{ item.product.name }}</h3>
                            <p class="text-sm text-gray-600">SKU: {{ item.product.sku|default:"-" }}</p>
                            {% if item.product.source == 'eprolo' %}
                            <span class="text-xs px-2 py-1 bg-purple-100 text-purple-800 rounded-full">
                                <i class="fas fa-link mr-1"></i>EPROLO
                            </span>
                            {% endif %}
                        </div>
                        
                        <div class="text-right">
                            <p class="text-sm text-gray-600">{{ item.quantity }} adet × {{ item.price }} ₺</p>
                            <p class="font-semibold text-gray-900">{{ item.total_price }} ₺</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Order Summary -->
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <div class="space-y-2">
                        <div class="flex justify-between text-gray-600">
                            <span>Ara Toplam:</span>
                            <span>{{ order.subtotal_amount|default:order.total_amount }} ₺</span>
                        </div>
                        {% if order.discount_amount %}
                        <div class="flex justify-between text-green-600">
                            <span>İndirim:</span>
                            <span>-{{ order.discount_amount }} ₺</span>
                        </div>
                        {% endif %}
                        {% if order.shipping_cost %}
                        <div class="flex justify-between text-gray-600">
                            <span>Kargo:</span>
                            <span>{{ order.shipping_cost }} ₺</span>
                        </div>
                        {% endif %}
                        <div class="flex justify-between text-xl font-bold text-gray-900 pt-2 border-t border-gray-200">
                            <span>Toplam:</span>
                            <span>{{ order.total_amount }} ₺</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Updates -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-history text-purple-600 mr-2"></i>
                    Durum Güncelle
                </h2>
                
                <form method="post" action="{% url 'shop:admin_order_detail' order.id %}" class="space-y-4">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sipariş Durumu</label>
                            <select name="status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Bekliyor</option>
                                <option value="confirmed" {% if order.status == 'confirmed' %}selected{% endif %}>Onaylandı</option>
                                <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Kargoda</option>
                                <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Teslim Edildi</option>
                                <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>İptal Edildi</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ödeme Durumu</label>
                            <select name="payment_status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="pending" {% if order.payment_status == 'pending' %}selected{% endif %}>Bekliyor</option>
                                <option value="paid" {% if order.payment_status == 'paid' %}selected{% endif %}>Ödendi</option>
                                <option value="refunded" {% if order.payment_status == 'refunded' %}selected{% endif %}>İade Edildi</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kargo Takip No</label>
                        <input type="text" name="tracking_number" value="{{ order.tracking_number|default:'' }}"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               placeholder="Kargo takip numarasını girin">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Not Ekle</label>
                        <textarea name="admin_notes" rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  placeholder="Sipariş hakkında not ekleyin...">{{ order.admin_notes|default:'' }}</textarea>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all shadow-lg">
                        <i class="fas fa-save mr-2"></i>Güncelle
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
            <!-- Customer Info -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-user text-purple-600 mr-2"></i>
                    Müşteri Bilgileri
                </h2>
                
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Ad Soyad</p>
                        <p class="font-medium text-gray-900">{{ order.user.get_full_name|default:order.user.username }}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">E-posta</p>
                        <p class="font-medium text-gray-900">{{ order.user.email }}</p>
                    </div>
                    {% if order.phone %}
                    <div>
                        <p class="text-sm text-gray-600">Telefon</p>
                        <p class="font-medium text-gray-900">{{ order.phone }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Shipping Address -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-map-marker-alt text-purple-600 mr-2"></i>
                    Teslimat Adresi
                </h2>
                
                <div class="text-gray-700 leading-relaxed">
                    {% if order.shipping_address %}
                    <p>{{ order.shipping_address.full_name }}</p>
                    <p>{{ order.shipping_address.address_line1 }}</p>
                    {% if order.shipping_address.address_line2 %}
                    <p>{{ order.shipping_address.address_line2 }}</p>
                    {% endif %}
                    <p>{{ order.shipping_address.city }}, {{ order.shipping_address.state }}</p>
                    <p>{{ order.shipping_address.postal_code }}</p>
                    <p>{{ order.shipping_address.country }}</p>
                    {% if order.shipping_address.phone %}
                    <p class="mt-2">Tel: {{ order.shipping_address.phone }}</p>
                    {% endif %}
                    {% else %}
                    <p class="text-gray-500 italic">Adres bilgisi mevcut değil</p>
                    {% endif %}
                </div>
            </div>

            <!-- Payment Info -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-credit-card text-purple-600 mr-2"></i>
                    Ödeme Bilgileri
                </h2>
                
                <div class="space-y-3">
                    <div>
                        <p class="text-sm text-gray-600">Ödeme Yöntemi</p>
                        <p class="font-medium text-gray-900">
                            {% if order.payment_method == 'credit_card' %}
                            <i class="fas fa-credit-card mr-1"></i>Kredi Kartı
                            {% elif order.payment_method == 'bank_transfer' %}
                            <i class="fas fa-university mr-1"></i>Havale/EFT
                            {% elif order.payment_method == 'cash' %}
                            <i class="fas fa-money-bill mr-1"></i>Kapıda Ödeme
                            {% else %}
                            {{ order.payment_method|default:"Belirtilmemiş" }}
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">Ödeme Durumu</p>
                        {% if order.payment_status == 'paid' %}
                        <span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-check mr-1"></i>Ödendi
                        </span>
                        {% elif order.payment_status == 'refunded' %}
                        <span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800">
                            <i class="fas fa-undo mr-1"></i>İade Edildi
                        </span>
                        {% else %}
                        <span class="px-3 py-1 text-sm font-semibold rounded-full bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock mr-1"></i>Bekliyor
                        </span>
                        {% endif %}
                    </div>
                    {% if order.paid_at %}
                    <div>
                        <p class="text-sm text-gray-600">Ödeme Tarihi</p>
                        <p class="font-medium text-gray-900">{{ order.paid_at|date:"d.m.Y H:i" }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Order Timeline -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="fas fa-clock text-purple-600 mr-2"></i>
                    Sipariş Zaman Çizelgesi
                </h2>
                
                <div class="space-y-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-cart text-green-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">Sipariş Oluşturuldu</p>
                            <p class="text-xs text-gray-500">{{ order.created_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>

                    {% if order.confirmed_at %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-blue-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">Onaylandı</p>
                            <p class="text-xs text-gray-500">{{ order.confirmed_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.shipped_at %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-truck text-purple-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">Kargoya Verildi</p>
                            <p class="text-xs text-gray-500">{{ order.shipped_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.delivered_at %}
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-box-check text-green-600 text-sm"></i>
                            </div>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">Teslim Edildi</p>
                            <p class="text-xs text-gray-500">{{ order.delivered_at|date:"d.m.Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl shadow-md p-6 text-white">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-bolt mr-2"></i>
                    Hızlı İşlemler
                </h2>
                
                <div class="space-y-2">
                    <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-2 rounded-lg transition-colors">
                        <i class="fas fa-envelope mr-2"></i>Müşteriye E-posta Gönder
                    </button>
                    <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-2 rounded-lg transition-colors">
                        <i class="fas fa-file-invoice mr-2"></i>Fatura Oluştur
                    </button>
                    <button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-2 rounded-lg transition-colors">
                        <i class="fas fa-undo mr-2"></i>İade İşlemi Başlat
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
