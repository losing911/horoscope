{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} - {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrastyle %}
<style>
    .horoscope-images-container {
        padding: 20px;
    }
    
    .date-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .date-navigation h2 {
        margin: 0;
        color: #333;
    }
    
    .date-nav-buttons {
        display: flex;
        gap: 10px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary {
        background: #417690;
        color: white;
    }
    
    .btn-primary:hover {
        background: #2e5266;
    }
    
    .btn-success {
        background: #28a745;
        color: white;
    }
    
    .btn-success:hover {
        background: #218838;
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #545b62;
    }
    
    .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 20px;
    }
    
    .image-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .image-card h3 {
        margin: 0 0 10px 0;
        color: #417690;
        font-size: 18px;
    }
    
    .image-preview {
        width: 100%;
        height: 250px;
        background: #f5f5f5;
        border-radius: 5px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
    }
    
    .image-preview img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }
    
    .image-preview.no-image {
        color: #999;
        font-size: 14px;
    }
    
    .image-status {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        font-size: 13px;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 12px;
    }
    
    .status-badge.success {
        background: #d4edda;
        color: #155724;
    }
    
    .status-badge.warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .status-badge.danger {
        background: #f8d7da;
        color: #721c24;
    }
    
    .image-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .image-actions button,
    .image-actions a {
        flex: 1;
        min-width: 100px;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    
    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="horoscope-images-container">
    <div class="date-navigation">
        <div class="date-nav-buttons">
            <a href="?date={{ prev_date }}" class="btn btn-secondary">‚Üê √ñnceki G√ºn</a>
            <a href="?date={{ selected_date }}" class="btn btn-primary">Bug√ºn</a>
            <a href="?date={{ next_date }}" class="btn btn-secondary">Sonraki G√ºn ‚Üí</a>
        </div>
        
        <h2>{{ selected_date|date:"d F Y" }}</h2>
        
        <button onclick="generateAllImages()" class="btn btn-success" id="generateAllBtn">
            ‚ú® T√ºm√ºn√º Olu≈ütur
        </button>
    </div>
    
    <div id="alertContainer"></div>
    
    <div class="images-grid">
        {% for data in images_data %}
        <div class="image-card" id="card-{{ data.sign.slug }}">
            <h3>{{ data.sign.symbol }} {{ data.sign.name }}</h3>
            
            <div class="image-status">
                {% if data.horoscope %}
                    <span class="status-badge success">‚úì Yorum Var</span>
                {% else %}
                    <span class="status-badge danger">‚úó Yorum Yok</span>
                {% endif %}
                
                {% if data.image_exists %}
                    <span class="status-badge success">‚úì G√∂rsel Var</span>
                {% else %}
                    <span class="status-badge warning">! G√∂rsel Yok</span>
                {% endif %}
            </div>
            
            <div class="image-preview {% if not data.image_url %}no-image{% endif %}">
                {% if data.image_url %}
                    <img src="{{ data.image_url }}" alt="{{ data.sign.name }}" loading="lazy">
                {% else %}
                    <span>G√∂rsel hen√ºz olu≈üturulmadƒ±</span>
                {% endif %}
            </div>
            
            <div class="image-actions">
                {% if data.horoscope %}
                    <button onclick="generateImage('{{ data.sign.slug }}', '{{ selected_date }}')" 
                            class="btn btn-primary"
                            {% if not data.horoscope %}disabled{% endif %}>
                        üé® Olu≈ütur
                    </button>
                {% endif %}
                
                {% if data.image_exists %}
                    <a href="{% url 'admin:download_horoscope_image' data.sign.slug selected_date %}" 
                       class="btn btn-success"
                       download="{{ data.image_filename }}">
                        ‚¨á ƒ∞ndir
                    </a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alertContainer.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

function generateImage(signSlug, date) {
    const card = document.getElementById(`card-${signSlug}`);
    card.classList.add('loading');
    
    fetch(`/admin/horoscope-images/generate/${signSlug}/${date}/`)
        .then(response => response.json())
        .then(data => {
            card.classList.remove('loading');
            if (data.success) {
                showAlert(data.message, 'success');
                // Sayfayƒ± yenile
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                showAlert(data.error || 'Bir hata olu≈ütu', 'error');
            }
        })
        .catch(error => {
            card.classList.remove('loading');
            showAlert('Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
        });
}

function generateAllImages() {
    const btn = document.getElementById('generateAllBtn');
    btn.disabled = true;
    btn.textContent = '‚è≥ Olu≈üturuluyor...';
    
    const date = '{{ selected_date }}';
    
    fetch(`/admin/horoscope-images/generate-all/${date}/`)
        .then(response => response.json())
        .then(data => {
            btn.disabled = false;
            btn.textContent = '‚ú® T√ºm√ºn√º Olu≈ütur';
            
            if (data.success) {
                showAlert(data.message, 'success');
                // Sayfayƒ± yenile
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showAlert(data.error || 'Bir hata olu≈ütu', 'error');
            }
        })
        .catch(error => {
            btn.disabled = false;
            btn.textContent = '‚ú® T√ºm√ºn√º Olu≈ütur';
            showAlert('Baƒülantƒ± hatasƒ±: ' + error.message, 'error');
        });
}
</script>
{% endblock %}
